<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adding a Picture</title>

      <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

</head>
<body>
<script>
    function imageTypeSelect(){
      $('#imageUrl').addClass('d-none');
      $('#imageFile').addClass('d-none');

      const selectType = $('#imageType').val();
      $(`#${selectType}`).removeClass('d-none');

      if( selectType==='imageFile' )
        $('#imageSizeCol').removeClass('d-none');
      else
        $('#imageSizeCol').addClass('d-none');
    }

    $(document).ready( async function(){
      // check if editing or new
      const editId = location.hash.substr(1);
      if( editId ){
        // looks like the user is wanting to edit this entry
        const editData = await $.get( `/api/thumbnail/${editId}` );
        // set up the form
        $('#name').val( editData.name );
        $('#imageUrl').val( editData.imageUrl );
        $('#tags').val( editData.tags );
        $('#thumbId').val( editData.thumbId );
      }

      $('#submitBtn').click( async function(event){
        event.preventDefault();

        // disable save button
        // $('#submitBtn').prop('disabled', true);

        const hasFile = $('#imageType').val()==='imageFile';
        const isEdit = $('#thumbId').val().length>0;
        if( hasFile && $('#imageFile').val()==='' ){
          alert('Please attach a file!'); 
          return;
        }

        // build our save object (FormData is javascript so we pass the jQuery 'javascript' object [0])
        // javascript FormData will accumulate any INPUT fields with a 'name' field
        const formData = new FormData( $('#mediaForm')[0] ); // $('#mediaForm')[0] );
        // const formData = {
        //   name: $('#name').val(),
        //   imageUrl: $('#imageUrl').val(),
        //   tags: $('#tags').val(),
        //   thumbId: $('#thumbId').val() /* this will only be set if editing */
        // };

        console.log( `.. isEdit(${isEdit}) hasFile(${hasFile}) ${isEdit ? 'PUT' : 'POST'} thumbId=(${$('#thumbId').val()})` );

        const apiResult = await $.ajax({
            url: '/api/thumbnails',
            type: isEdit ? 'PUT' : 'POST',
            /* because we are passing in FormData() we must turn off jQuery processing */
            processData: false,
            contentType: false,
            data: formData 
          });
        
        if( apiResult.error ){
          alert( apiResult.error );
          return false;
        }

        alert( apiResult.message );
        // redirect to the main page (listing thumbnails)
        location.href = '/index.html';
      })
    })
</script>

    <main role="main">

        <section class="jumbotron text-center">
          <div class="container">
            <h1>Our Greatest Memories Pinboard</h1>
            <p class="lead text-muted">Sometimes you forget how many wonderful memories you have already experienced.</p>
          </div>
        </section>
      
        <!-- add picture form -->
        <div class="container">
          <div class="card">
            <div class="card-header">
              Add Picture
            </div>
            <div class="card-body">
              <form id='mediaForm' role="form" enctype="multipart/form-data" method="POST">
                <input type='hidden' id='thumbId' name='thumbId' value=''>
                <div class="form-group">
                  <label for="name">Name:</label>
                  <input type="text" class="form-control" id="name" name='name'>
                </div>
                <div class="form-group">
                  <label for="imageUrl" class='row'>
                    <div class='col-6'>
                      <select onChange='imageTypeSelect()' id="imageType" name="imageType" class='form-control'>
                        <option value="imageUrl">Image Url:</option>
                        <option value="imageFile">Image File:</option>
                      </select>
                    </div>
                    <div id='imageSizeCol' class='col-6 d-none'>
                      <select id="imageSize" name="imageSize" class='form-control'>
                        <option value="0x0">.. Resize ..</option>
                        <option value="256x256">Thumbnail</option>
                        <option value="1024x1024">Normal</option>
                        <option value="5000x5000">Jumbo</option>
                      </select>
                    </div>
                  </label>
                  <input type="text" class="form-control" id="imageUrl" name='imageUrl'>
                  <input type="file" id="imageFile" name="imageFile" class='form-control d-none'>
                </div>
                <div class="form-group">
                  <label for="tags">Tags:</label>
                  <input type="text" class="form-control" id="tags" name='tags'>
                </div>
                <button id='submitBtn' type="submit" class="btn btn-primary submit">Save</button>
              </form>
            </div>
          </div>
        </div>
        
      </main>

</body>
</html>